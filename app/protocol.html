<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:mp="https://dev.mobbr.com/protocol" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Cascaded Participation Ranking (CPR) scripts</title>
    <link rel="shortcut icon" type="image/x-icon" href="/images/uploads/icons/oupp_icon.png"/>
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="Cascaded Participation Ranking (CPR) scripts" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://dev.mobbr.com/protocol/" />
    <meta property="og:image" content="https://dev.mobbr.com/img/openmicropaymentprotocol.jpg" />
    <meta property="og:description" content="The Cascaded Participation Ranking (CPR) scripts enables any web page to specify participation rankings of social collaboration objects associated with the page. " />
    <meta name="original-source" content="https://dev.mobbr.com/protocol" />
    <meta name="participation" content='{"participants" : [{"id":"https://mobbr.com/id/Patrick"}]}'/>
    <style type="text/css">
        body
            {
                background: white;
                color: black;
                font-family: Georgia, serif;
                font-size: 11pt;
                margin: 10px;
                margin-top: 15px;
                margin-bottom: 15px;
            }

        h1, h2, h3, h4
            {
                font-family: Calibri, sans-serif;
                margin: 0;
            }

        img
            {
                border: 0;
            }

        pre, code
            {
                color: #060;
            }

        a, a code
            {
                color: #3b5998;
            }

        table
            {
                border-collapse: collapse;
                border: 0;
            }

        td
            {
                border: 0;
                padding: 0;
            }

        #body
            {
                margin: auto;
                max-width: 850px;
            }

        #header
            {
                margin-bottom: 15px;
                margin-right: 30px;
                text-align: center;
            }

        #content, #footer
            {
                margin-left: 31px;
                margin-right: 31px;
            }

        #content p, #content li, #footer
            {
                line-height: 16pt;
            }

        #content pre
            {
                line-height: 14pt;
                margin: 17pt;
                padding-left: 1em;
                border-left: 1px solid #ccc;
            }

        #footer
            {
                margin-top: 1em;
            }

        #content h1, #content h2, #content h3
            {
                color: #666;
                margin-bottom: 2pt;
                margin-top: 17pt;
            }

        #content h2
            {
                font-size: 19pt;
            }

        #content h3
            {
                font-size: 15pt;
            }

        #content p
            {
                margin: 0;
                margin-bottom: 1em;
            }
    </style>
</head>
<body>
    <div id="body">
        <div id="header">
            <h1>The Cascaded Participation Ranking protocol (CPR-script)</h1>
            <img src="/img/openmicropaymentprotocol.jpg" alt="CPR-protocol"/>
        </div>
        <div id="content">
            <h2>Introduction</h2>
            <p>
                The CPR protocol enables any web page to specify its social participation ranking.
                This is used by services like <a href="https://dev.mobbr.com/">Mobbr</a>
                to distribute payments and donations. The ranking reflects the value added to the page
                or associated products by different participants.
            </p>
            <p>In social collaboration every participant will have his own share of total added value.</p>
            <p>The protocol can be used to describe participation levels using the following types of scripts:</p>
            <ul>
                <li>
                    <a href="#button">Button-scripts</a>
                </li>
                <li>
                    <a href="#xhtml">Page-scripts</a>
                </li>
                <li>
                    <a href="#domain">Domain-scripts</a>
                </li>
                <li>
                    <a href="#dns">DNS-scripts</a>
                </li>
            </ul>
            <p>
                These desciptions types can be combined, or '<a href="#cascading">cascaded</a>' for more flexibility.
                </li>

            </p>
            <p>
                The protocol is based on <a href="http://en.wikipedia.org/wiki/JSON">JSON</a>
                (Javascript Object Notation). JSON-syntaxis can
                be checked using a <a href="http://www.jsonlint.com/">online parser</a>
                and JSON-support is good in every major programming language as well as
                in Javascript.
            </p>
            <p>
                A formal description of valid JSON-specifications can be found at the bottom of this document.
			</p>
            <ul>
                <li>
                    <a href="#specs">Specification</a>
                </li>
            </ul>
            <hr/>
            <p>
                <a id="cascading"></a>
            </p>
            <h2>Cascading-rules</h2>
            <p>
                It is possible to supply a button script as well as a page script as well as a domain script as well as a DNS script. In this case the
                processor will cascade (combine) the values in the following order:
            </p>
            <ol>
                <li>DNS script</li>
                <li>domain script</li>
                <li>page script</li>
                <li>button script</li>
            </ol>
            <p>
            The scripts are combined and duplicate values are overwritten in the order given above. Percentage shares
            are summed. If only percentages are used for shares, the sum of shares should be excactly 100%.
            Any remaining, not assigment, percentage is shared among the relative shares using the indicated ratios.
            </p>
            <p>
            Participants can never be overwritten through cascading scripts, to combine participants with the same ID they need to have different roles.
            </p>
            <p>
            Using this logic it is possible to specify global participants in the /PARTICIPATION.TXT that can never be excluded by
            button or page scripts. For instance the website owner and such. If such a recipient such has a percentage share, his
            share can never be reduced nor excluded.
            </p>
            <hr/>
            <p>
                <a id="button"></a>
            </p>
            <h2>Button scripts</h2>
            <p>
                If active web-elements such as buttons are used to trigger actions such as payments, they need to send a JSON-structure
                to the server of the payment-service (using a FORM-POST). This JSON-structure can contain all information needed to fullfill the transaction.
            </p>
            <p>
                This is how it is done using the Mobbr-API. This javascript will post a variable called 'data' to the Mobbr gateway. Its contents is the JSON-script enclosed in "{...}".
            </p>
            <pre><code>&lt;script src="https://mobbr.com/mobbr-button.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
mobbr.button(
    {
        "id-base" : "https://mobbr.com/id/",
        "title" : "iPhony",
        "description" : "Planned obscolescence device",
        "participants" : [
            {
                "id": "patman",
                "role": "author",
                "share": "3"
            },
            {
                "id": "johnny",
                "role": "author",
                "share": "3"
            },
            {
                "id": "zaplog",
                "role": "platform",
                "share": "1"
            }
        ]
    }
);
&lt;/script&gt;</code></pre>
            <p>
                <a href="#specs">See below</a>
                for a full description of the JSON-elements.
            </p>
            <p>
                When used together with page- and / or domain-scripts, cascading-rules apply, see below.
            </p>
            <hr/>
            <p>
                <a id="xhtml"></a>
            </p>
            <h2>Page-scripts (inline)</h2>
            <p>
                To turn your web pages into payable objects without buttons or other active elements,
                you need to add metadata to your page. We've chosen <em>not</em> to base the (initial version of the protocol)
                on <a href="http://en.wikipedia.org/wiki/RDFa">RDFa</a> syntax
                like The Facebook open-graph protocol, but to use a more conventional
				and scalable approach: just place a <a href="http://www.json.org/">JSON</a>
                description in the content-part of a <code>&lt;meta&gt;</code>
                tags in the <code>&lt;head&gt; </code>
                of your web page. This approach allows for W3C valid (X)HTML <b>and</b>
                to use the same JSON format other OuPP-elements use.
            </p>
            <p>
                As an example, the following is the Open Micropayment Protocol markup
                for an item associated with a website:
            </p>
            <pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html
	xmlns=http://www.w3.org/1999/xhtml
	xml:lang="en" &gt;
&lt;head&gt;
	<b>&lt;meta name="participation" content='
		{
			"id-base" : "https://mobbr.com/id/",
			"title" : "The iPhony4",
			"description" : "Article about some fictious planned obscolescence device",
			"participants" : [
			    {
			        "id": "patman",
			        "role": "author",
			        "share": "3"
			    },
			    {
			        "id": "johnny",
			        "role": "author",
			        "share": "3"
			    },
			    {
			        "id": "zaplog",
			        "role": "platform",
			        "share": "1"
			    }
			]
		}
	'/&gt;</b></code></pre>
            <p>
                <i><strong><small>Note: because JSON requires double quotes, the entire JSON definition itself
                    (the content-attribute) should be enclosed in single quotes.</small></strong></i>
            </p>
            <p>
                <i><strong><small>Note: this construction is W3C valid.</small></strong></i>
            </p>
            <p>
                When used together with button- and / or domain-scripts, cascading-rules apply, see below.
            </p>
            <h2>Page-scripts (external)</h2>
            <p>
                As an alternative a HTML-LINK can be used, linking to <a href="https://dev.mobbr.com/mobbr-payment_info.json">an external JSON-description</a>. Like below:
            </p>
            <pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;
&lt;html
    xmlns=http://www.w3.org/1999/xhtml
    xml:lang="en" &gt;
&lt;head&gt;
    <b>&lt;link rel="participation" type="application/json" href="https://dev.mobbr.com/mobbr-payment_info.json"/&gt;</b></code></pre>
            <h2>Helpfull (X)HTML elements</h2>
            <p>Additional metadata / properties that can help the payments system to make intelligent decisions:</p>
            <ul>
                <li>The HTML &lt;title&gt; element.</li>
                <li>A metadata name="description" <a href="http://www.w3schools.com/tags/tag_meta.asp">element</a>.</li>
                <li>A metadata name="canonical" <a href="http://googlewebmastercentral.blogspot.com/2009/02/specify-your-canonical.html">element</a>.</li>
                <li>A metadata name="original-source" <a href="http://googlenewsblog.blogspot.com/2010/11/credit-where-credit-is-due.html">element(s)</a>.</li>
                <li>A metalink rel="copyright" <a href="http://htmlhelp.com/reference/html40/head/link.html">element</a>, defining sharing and derivation rights</li>
                <li>
                    A correct set of <a href="http://ogp.me/">OG-properties</a>, as
                    used by Facebook.
                </li>
            </ul>
            <p>This is not OuPP specific though, it is good webdesign practice in general. If possible make your pages W3C valid.</p>
            <hr/>
            <p>
                <a id="dns"></a>
            </p>
            <h2>DNS scripts</h2>
            <p>
                A payment script similar to the page-scripts can be placed in a TXT-record of the DNS of a domain.
                The script should be perpendend with '[CPR]'
            </p>
            <hr/>
            <p>
                <a id="domain"></a>
            </p>
            <h2>Domain description (domain script)</h2>
            <p>
                As an alternative to tagging individual pages with metadata, a domain
                or website can specify global settings in a PARTICIPATION.TXT file. This
                file needs to be placed in the root of the domain, like for
                instance the <a href="http://www.robotstxt.org/">ROBOTS.TXT</a>
                file.
            </p>
            <p>
            	In this file the default and/or global participation properties can be
                defined.
		    </p>
            <p>
                When used together with button- and / or page-scripts, cascading-rules apply, see below.
            </p>
            <p>
            	The format is straightforward: the file defines sets of
                properties that are applied to the URL's that match the
                wildcard-pattern. The properties will be applied to every URL
                that matches the pattern in order of declaration. The wildcard character is
                '*', matching zero, one or many arbitrary characters. Any '*' that occurs
                naturally in the URL (which is very rare), must be escaped (preceded) with a '\'.
			</p>
            <p>
            	The following example describes the properties for a complete
                website.
			</p>
            <pre><code>[
	{
	    "url-pattern" : "*",
		"participation-info":
		{
	        "id-base" : "https://mobbr.com/id/",
	        "participants" :
			[
	            {
	                "id" : "83495",
	                "role" : "website-owner",
	                "share" : "1"
	            }
	        ]
	    }
	},
	{
	    "url-pattern" : "/article/*",
		"participation-info" :
		{
	        "id-base" : "https://mobbr.com/id/",
	        "type" : "fixed-price",
	        "amount" : "1.5",
	        "currency" : "EUR",
	        "participants" :
			[
	            {
	                "id" : "83495",
	                "role" : "distributer",
	                "share" : "1"
	            },
	            {
	                "id" : "6424",
	                "role" : "author",
	                "share" : "4"
	            },
	            {
	                "id" : "964242",
	                "role" : "reviewer",
	                "share" : "1"
	            }
	        ]
		}
	},
	{
	    "url-pattern" : "/article/*/picture",
		"participation-info" :
		{
            "id-base" : "https://mobbr.com/id/",
	        "amount" : "1.5",
	        "participants" :
			[
	            {
	                "id" : "83495",
	                "role" : "photographer",
	                "share" : "1"
	            }
	        ]
		}
	}
]</code></pre>
            <p>
                <a href="#specs">See below</a> for a full description of the JSON-elements.
            </p>
            <p>
                It is possible that different patterns match the same URL. Properties are then cascaded (if not present)
                or overwritten (if already present) in top to bottom order, combining all matching rules.
				This cascading may not lead to duplicate participants being inserted which is allowed as long
				as the roles differ.
            </p>
            <hr/>
            <p>
                <a id="specs"></a>
            </p>
            <h2>Specification</h2>
            <img src="/img/open-micropayment_protocol-OuPP-json-spec.png" alt="railroad diagram of OuP-protocol JSON"/>
            <p>The required properties for every page are:</p>
            <p>Required for all cases that specify 'relative participants'.</p>
            <ul>
                <li>
                    <code>"id-base"</code>
                    - URL (-prefix) that, combined with an ID, forms an URL uniquely identifying a person or member
					within that service. Together, the id-base and an relative ID should form
					a valid URL. If the id-base
					is ommitted, every recipient should be a full URL, identifying the recipient.
				</li>
            </ul>
            <p>Required if scripts are used for fixed-price payments.</p>
            <ul>
                <li>
                    <code>"type"</code>
                    - The <a href="#types">type</a>
                    of the requested payment or payment, if none is given,
                    "payment" will be assumed. Not all systems support multipe payment-types.
                </li>
                <li>
                    <code>"amount"</code>
                    - The requested price, if appropriate for the type.
                </li>
                <li>
                    <code>"currency"</code>
                    - The currency in which the price is expressed.
                </li>
            </ul>
            <p>The optional properties for every page are:</p>
            <ul>
                <li>
                    <code>"url"</code>
                    - The URL identifying the product if it is not the referrer-URL or URL on which the
                    button is placed. Not allowed / ignored for metatag-version of JSON.
                </li>
                <li>
                    <code>"image"</code>
                    - The URL or BASE64 encoded content of an image for this product.
                </li>
                <li>
                    <code>"callback-url"</code>
                    - The URL that needs to be called back upon initial acceptance of the transaction. This means
					the customer has accepted the terms. The payment-service will HTTP-POST the transaction-JSON. This URL
                    must be on the same domain as the originating payment.
                </li>
                <li>
                    <code>"confirm-url"</code>
                    - The URL that needs to be called back upon final completion of the transaction. This means the
					customer has completed the purchase. The payment-service will HTTP-POST the transaction-JSON. This URL
					must be on the same domain as the originating payment. The URL must respond by echoing the POST, indicating
					it also agrees to the transaction.
                </li>
                <li>
                    <code>"forward-url"</code>
                    - The URL that needs to displayed after initially accepting the transaction (e.g. clicking a button). This URL
                    must be on the same domain as the originating payment.
                </li>
                <li>
                    <code>"participants"</code>
                    - A JSON-list of one or more participations. Not all
                    payment-processors support multiple participants.
                    <ul>
                        <li>
                            <code>"id"</code>
                            - The ID with which the payment-processor can identify the recipient. Combined
							with the "id-base" is forms a valid URL. Most probably to the profile-page of the user. It can
							also be a full, valid URL in which case the contents (response) of the URL must be an email address.
                        </li>
                        <li>
                            <code>"role"</code>
                            - Description of the role or part the recipient played in getting this product to you.
                        </li>
                        <li>
                            <code>"share"</code>
                            - Positive integer or percentage. Integer shares of the payment or payment relative to the other shares. '1' will be used as default.
                        </li>
                    </ul>
                </li>
                <li>
                    <code>"title"</code>
                    - Name of the product. The HTML-tag <code>&lt;title&gt;</code> of the page will be used if no name is given.
                </li>
                <li>
                    <code>"description"</code>
                    - Description of the product. If not present, the HTML-metatag
                    <code>&lt;meta name="description" content="..." /&gt; </code>
                    of the page will be used. Else the OG:description tag could
					be used as fallback.
                </li>
                <li>
                    <code>"mimetype"</code>
                    - The <a href="http://www.iana.org/assignments/media-types/index.html">mime-type</a>
                    of the object the user can buy.
                </li>
                <li>
                    <code>"comment"</code>
                    - As it says: comment. Will be ignored though size limits can be imposed.
                </li>
            </ul>
            <hr/>
            <p>
                <a id="ids"></a>
            </p>
            <h2>External ID's</h2>
            <p>
            	It is possible to use ID's that do not belong to the service (id-base) indicated. In that case
                the ID's must be full URL's. The payment service may choose to ignore / reject those or to offer some kind
				of fail-over / alternative mechanism to try to get the payments to those persons.
			</p>
            <p>
            	For practical purposes, email- ('mailto:') or Twitter URL's and such are probably most convenient
				to use as external URL's since it offers a direct mechanismen to contact and verify a recipient.
			</p>
            <p>
                Also possible are bitcoin addresses. These offer good anonimity and are directly payable in bitcoin. Also restricted to bitcoins only.
            </p>
            <p>
            	Below an example of a JSON transaction description with external ID's.
			</p>
            <pre><code>
        {
            "id-base" : "https://mobbr.com/id/",
            "title" : "The iPhony4",
            "description" : "Article about some fictious planned obscolescence device",
            "participants" : [
                {
                    "id": "Paramatman",
                    "comment": "Relative URL, relative to id-base",
                    "role": "author",
                    "share": "3"
                },
                {
                    <b>"id": "mailto:patman@zaplog.nl",</b>
                    "comment" : "Straight email-address URL",
                    "role": "co-author",
                    "share": "3"
                },
                {
                    <b>"id": "http://gravatar.com/patricksavalle",</b>
                    "comment": "This is a URL of a person outside the id-base",
                    "role": "co-author",
                    "share": "1"
                },
                {
                    <b>"id": "https://twitter.com/#!/mobbrcom",</b>
                    "comment": "The twitter-URL of @mobbrcom",
                    "role": "co-author",
                    "share": "1"
                } ,
                {
                    <b>"id": "bitcoin:1NS17iag9jJgTHD1VXjvLCEnZuQ3rJED9L",</b>
                    "comment": "The bitcoin address to receive payments",
                    "role": "co-author",
                    "share": "1"
                }

            ]
        }
    </code></pre>
            <p>How and if such external ID's are handled, is up to the payment-provider.</p>
        </div>
        <p>
            <a href="http://validator.w3.org/check?uri=referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0 Strict" height="31" width="88" /></a>
        </p>
    </div>
</body>
</html>